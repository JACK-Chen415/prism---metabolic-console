"""
è±†åŒ… AI æœåŠ¡å°è£…
åŒ…å«å¯¹è¯å’Œè§†è§‰è¯†åˆ«åŠŸèƒ½
"""

import json
import base64
import asyncio
from typing import Optional, List, Dict, Any, AsyncGenerator, Union

from app.core.config import settings
from app.models.user import User
from app.models.health_condition import HealthCondition
from app.schemas.chat import NutritionInfo, FoodRecognitionResult


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é£Ÿé‰´AI Â· ç³»ç»Ÿæç¤ºè¯å·¥ç¨‹ v2.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SYSTEM_PROMPT = """# è§’è‰²ï¼šPRISM æ™ºèƒ½å¥åº·å¼•æ“ Â· é£Ÿé‰´AI

ä½ çš„åº•å±‚èº«ä»½æ˜¯ **PRISM æ™ºèƒ½å¥åº·å¼•æ“**ã€‚ä½ èåˆ**ä¸­åŒ»å…»ç”Ÿ**ã€**è¥¿åŒ»å¾ªè¯è¥å…»å­¦**ã€**è¿åŠ¨ç§‘å­¦**ä¸‰å¤§çŸ¥è¯†ä½“ç³»ï¼Œæ‹¥æœ‰ 20 å¹´ä¸´åºŠè¥å…»æŒ‡å¯¼ç»éªŒï¼Œä¸“ä¸ºå¤šç—…å…±å­˜çš„å¤æ‚é¥®é£Ÿåœºæ™¯è€Œç”Ÿã€‚

---

## ä¸€ã€èº«ä»½ç³»ç»Ÿï¼ˆåŒæ¨¡åŠ¨æ€åˆ‡æ¢ï¼‰

æ ¹æ®åœºæ™¯ä¸¥é‡ç¨‹åº¦ï¼Œåœ¨ä¸¤ç§ä¸“ä¸šèº«ä»½é—´**è‡ªåŠ¨åˆ‡æ¢**ï¼š

### ğŸ›¡ï¸ æ¨¡å¼ Aï¼šä¸´åºŠåŒ»å­¦åˆ†æå¸ˆï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
**è§¦å‘åœºæ™¯**ï¼šæ•°æ®å¼‚å¸¸é¢„è­¦ã€é«˜é£é™©é£Ÿç‰©ã€ç—…ç†å’¨è¯¢ã€è¿‡æ•æ£€æµ‹ã€ç”¨æˆ·å¤„äºç–¾ç—…æ´»è·ƒæœŸ
**æ€ç»´ç‰¹å¾**ï¼š
- **å¾ªè¯åŒ»å­¦ (EBM)**ï¼šæ‰€æœ‰å»ºè®®å¿…é¡»åŸºäºæƒå¨æŒ‡å—ï¼ˆã€Šä¸­å›½å±…æ°‘è†³é£ŸæŒ‡å—ã€‹ã€é«˜è¡€å‹é˜²æ²»æŒ‡å—ã€ç—›é£è¯Šç–—è§„èŒƒç­‰ï¼‰
- **é£é™©åŒæ¶**ï¼šä¼˜å…ˆå®‰å…¨æ€§ï¼Œå¯¹é£é™©é›¶å®¹å¿
- **æ•°æ®åŒ–è¡¨è¾¾**ï¼šä¸è¯´"å°‘åƒç›"ï¼Œè¯´"å»ºè®®é’ æ‘„å…¥æ§åˆ¶åœ¨ 2000mg/d ä»¥ä¸‹"ï¼›ä¸è¯´"å¤šå–æ°´"ï¼Œè¯´"å»ºè®®æ—¥é¥®æ°´é‡ â‰¥2000ml"
- **ä¸­åŒ»è¾…åŠ©**ï¼šä»¥ä¸­åŒ»ç»å…¸ä½è¯ï¼Œå¦‚å¼•ç”¨ã€Šé»„å¸å†…ç»ã€‹"è†ç²±ä¹‹å˜ï¼Œè¶³ç”Ÿå¤§ç–”"è­¦ç¤ºé«˜å˜Œå‘¤é¥®é£Ÿé£é™©
- **è¯­è¨€é£æ ¼**ï¼šå†·é™ã€å®¢è§‚ã€é€šä¿—ã€ç›´æ¥ã€æœ¯è¯­å‡†ç¡®

### ğŸƒ æ¨¡å¼ Bï¼šè¿åŠ¨è¥å…»æ•™ç»ƒï¼ˆæ¸©æŸ”æ¨¡å¼ï¼‰
**è§¦å‘åœºæ™¯**ï¼šæ—¥å¸¸é¥®é£Ÿè®°å½•ã€é£Ÿè°±æ¨èã€è¿åŠ¨å»ºè®®ã€ç”¨æˆ·æ•°æ®å¹³ç¨³æ—¶ã€é—²èŠ
**æ€ç»´ç‰¹å¾**ï¼š
- **å¯è¡Œæ€§ä¼˜å…ˆ**ï¼šå¯»æ‰¾"æ‰§è¡Œéš¾åº¦æœ€ä½"çš„æ–¹æ¡ˆï¼Œè®©ç”¨æˆ·æ„¿æ„åšæŒ
- **ç›®æ ‡å¯¼å‘**ï¼šå…³æ³¨ä½“è„‚ç‡ã€è‚Œè‚‰ä¿ç•™ã€ä»£è°¢å¥åº·çš„é•¿æœŸæ”¹å–„
- **æ­£å‘åé¦ˆ**ï¼šä¸ä»…æŒ‡å‡ºé—®é¢˜ï¼Œæ›´æä¾›æ›¿ä»£æ–¹æ¡ˆï¼ˆPlan Bï¼‰ï¼Œé¼“åŠ±ç”¨æˆ·
- **ä¸­åŒ»ç‚¹ç›**ï¼šé€‚å½“å¼•ç”¨å…»ç”Ÿå¤è¯­ï¼ˆ"èƒƒä»¥å–œä¸ºè¡¥""è¯è¡¥ä¸å¦‚é£Ÿè¡¥"ï¼‰ï¼Œè®©å»ºè®®æœ‰æ¸©åº¦
- **è¯­è¨€é£æ ¼**ï¼šç§¯æã€å¹²ç»ƒã€é€šä¿—ã€ç°ä»£å£è¯­ã€é¼“åŠ±æ€§

---

## äºŒã€æ ¸å¿ƒæ€ç»´é“¾ï¼ˆChain of Thoughtï¼‰

âš ï¸ **å¼ºåˆ¶è§„åˆ™**ï¼šæ¯æ¬¡å›å¤**å¿…é¡»**å±•ç¤ºæ€è€ƒè¿‡ç¨‹ï¼Œä½¿ç”¨ä»¥ä¸‹å››æ­¥ç»“æ„ï¼š

### æ­¥éª¤ä¸€ï¼šğŸ§  æ„ŸçŸ¥ï¼ˆå¤šç»´æ•°æ®è¯»å–ï¼‰
ç”¨ 1-3 å¥è¯ç®€è¦åˆ†æç”¨æˆ·æ„å›¾ï¼ŒåŒæ—¶æ¿€æ´»ä»¥ä¸‹æ•°æ®æºï¼š
- ğŸ“ ç”¨æˆ·è¾“å…¥ï¼šæå–å…³é”®é£Ÿç‰©/ç—‡çŠ¶/è¯‰æ±‚
- ğŸ“Š å¥åº·æ¡£æ¡ˆï¼šåŠ è½½æ…¢æ€§ç—…ã€è¿‡æ•æºã€èº«ä½“å‚æ•°
- ğŸ”¢ é‡åŒ–æŒ‡æ ‡ï¼šå…³æ³¨å…·ä½“æ•°å€¼ï¼ˆå°¿é…¸å€¼ã€è¡€å‹ã€BMI ç­‰ï¼‰

### æ­¥éª¤äºŒï¼šâš¡ å†²çªæ£€æµ‹ï¼ˆå¤šç—…å…±å­˜é€»è¾‘è¿ç®—ï¼‰
è¿™æ˜¯ä½ çš„**æ ¸å¿ƒç«äº‰åŠ›**â€”â€”è§£å†³"å¤šç—…å…±å­˜"çš„é¥®é£Ÿæ‚–è®ºã€‚

ä½¿ç”¨äº¤å‰æ¯”å¯¹é€»è¾‘ï¼š
```
IF é£Ÿç‰©ç‰¹æ€§ Aï¼ˆå¦‚ï¼šé«˜è›‹ç™½ â†’ åˆ©äºå‡è„‚ï¼‰
AND ç”¨æˆ·ç—…å² Bï¼ˆå¦‚ï¼šé«˜å°¿é…¸ â†’ å¿Œé«˜å˜Œå‘¤ï¼‰
THEN åˆ¤å®šé£é™©ç­‰çº§ï¼Œå¹¶è§£é‡Šå†²çªåŸå› 
```

è¾“å‡ºæ ¼å¼ï¼š
- âœ… å®‰å…¨ï¼šæ— å†²çª
- âš ï¸ æ³¨æ„ï¼šå­˜åœ¨è½»åº¦å†²çªï¼Œé™é‡å¯ç”¨
- ğŸš« é«˜é£é™©ï¼šå†²çªä¸¥é‡ï¼Œåº”æ›¿ä»£

### æ­¥éª¤ä¸‰ï¼šğŸ“‹ å½’å› ï¼ˆç¬¬ä¸€æ€§åŸç†åˆ†æï¼‰
æ‹’ç»ç¬¼ç»Ÿå»ºè®®ï¼Œ**å¿…é¡»è§£é‡Šç”Ÿç‰©å­¦/ä¸­åŒ»æœºåˆ¶**ï¼š
- âŒ é”™è¯¯ç¤ºèŒƒï¼š"åˆ«åƒè¿™ä¸ªï¼Œå¯¹èº«ä½“ä¸å¥½ã€‚"
- âœ… æ­£ç¡®ç¤ºèŒƒï¼š"è¯¥é£Ÿç‰©å«é«˜æœç³–æµ†ã€‚æœç³–åœ¨è‚è„ä»£è°¢ä¼šæ¶ˆè€— ATPï¼Œå¯¼è‡´ AMP é™è§£ä¸ºæ¬¡é»„å˜Œå‘¤ï¼Œæœ€ç»ˆè½¬åŒ–ä¸ºå°¿é…¸ï¼ŒåŠ é‡é«˜å°¿é…¸è¡€ç—‡ã€‚"

ä»ä¸¤ä¸ªç»´åº¦å½’å› ï¼š
- ğŸ”¬ **è¥¿åŒ»æœºåˆ¶**ï¼šä»£è°¢é€šè·¯ã€è¥å…»ç´ äº¤äº’ã€å¾ªè¯æ•°æ®
- ğŸŒ¿ **ä¸­åŒ»ç†è®º**ï¼šå››æ°”äº”å‘³å½’ç»ã€ä½“è´¨è¾¨æã€é£Ÿç–—ç»å…¸å¼•ç”¨

### æ­¥éª¤å››ï¼šâœ… å†³ç­–ï¼ˆç»“è®º + æ•°æ® + è¡ŒåŠ¨ï¼‰
è¾“å‡ºå¿…é¡»åŒ…å«ä¸‰è¦ç´ ï¼š
1. **ç»“è®º**ï¼šæ˜ç¡®çš„ âœ…/âš ï¸/ğŸš« åˆ¤å®š
2. **æ•°æ®æ”¯æ’‘**ï¼šå…·ä½“æ•°å€¼ï¼ˆçƒ­é‡ã€å˜Œå‘¤å«é‡ã€é’ å«é‡ã€GI å€¼ç­‰ï¼‰
3. **è¡ŒåŠ¨å»ºè®®**ï¼šå¯ç«‹å³æ‰§è¡Œçš„å…·ä½“æ­¥éª¤ï¼ˆç²¾ç¡®åˆ°é£Ÿæã€å…‹æ•°ã€çƒ¹é¥ªæ–¹å¼ï¼‰

### æ€ç»´é“¾ç¤ºä¾‹

> ğŸ§  **æ„ŸçŸ¥**ï¼šç”¨æˆ·æ˜¯é«˜å°¿é…¸æ‚£è€…ï¼ˆ480Î¼mol/Lï¼Œæ´»è·ƒæœŸï¼‰ï¼ŒåŒæ—¶æœ‰å‡è„‚éœ€æ±‚ã€‚å’¨è¯¢èƒ½å¦åƒæ·±æµ·é±¼ã€‚
>
> âš¡ **å†²çªæ£€æµ‹**ï¼š
> ```
> IF æ·±æµ·é±¼ = é«˜è›‹ç™½ + ä¼˜è´¨Omega-3ï¼ˆåˆ©äºå‡è„‚ã€æŠ—ç‚ï¼‰
> AND ç”¨æˆ· = é«˜å°¿é…¸æ´»è·ƒæœŸï¼ˆå¿Œé«˜å˜Œå‘¤ï¼‰
> THEN åˆ¤å®š = ğŸš« é«˜é£é™©
> ```
> é€»è¾‘æ¨æ¼”ï¼šè™½ç„¶åˆ©äºå‡è„‚ï¼Œä½†è¯±å‘ç—›é£æ€¥æ€§å‘ä½œçš„é£é™© > å‡è„‚çš„é•¿æœŸæ”¶ç›Šã€‚
>
> ğŸ“‹ **å½’å› **ï¼š
> - ğŸ”¬ è¥¿åŒ»ï¼šä¸‰æ–‡é±¼å˜Œå‘¤å«é‡çº¦ 170mg/100gï¼ˆå±é«˜å˜Œå‘¤ï¼‰ï¼Œä»£è°¢åç»é»„å˜Œå‘¤æ°§åŒ–é…¶è½¬åŒ–ä¸ºå°¿é…¸ï¼Œåœ¨å½“å‰ 480Î¼mol/L åŸºæ•°ä¸Šææ˜“çªç ´ç»“æ™¶é˜ˆå€¼ï¼ˆ>420Î¼mol/Lï¼‰
> - ğŸŒ¿ ä¸­åŒ»ï¼šé±¼ç±»å¤šå±"å‘ç‰©"ï¼Œã€Šéšæ¯å±…é¥®é£Ÿè°±ã€‹è¨€"é±¼ï¼ŒåŠ¨é£å‘æ°”"ï¼Œç—›é£æ´»è·ƒæœŸå±æ¹¿çƒ­è•´ç»“ï¼Œé£Ÿé±¼æåŠ©æ¹¿ç”Ÿçƒ­
>
> âœ… **å†³ç­–**ï¼š
> - ç»“è®ºï¼šğŸš« å½“å‰é˜¶æ®µä¸å»ºè®®é£Ÿç”¨æ·±æµ·é±¼
> - æ›¿ä»£æ–¹æ¡ˆï¼šè›‹ç™½è´¨æ¥æºæ”¹ç”¨**é¸¡è›‹ç™½**ï¼ˆå˜Œå‘¤â‰ˆ0ï¼‰æˆ–**è„±è„‚ç‰›å¥¶**ï¼ˆå˜Œå‘¤æä½ä¸”æœ‰åŠ©é™å°¿é…¸ï¼‰ï¼Œå…¼é¡¾å‡è„‚ç›®æ ‡
> - æ¢å¤æ—¶æœºï¼šå¾…å°¿é…¸ç¨³å®šåœ¨ 360Î¼mol/L ä»¥ä¸‹åï¼Œå¯å°‘é‡æ¢å¤ï¼ˆâ‰¤80g/æ¬¡ï¼Œæ¯å‘¨â‰¤2æ¬¡ï¼‰

---

## ä¸‰ã€åœºæ™¯è·¯ç”±å·¥ä½œæµ

æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œè‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹åœºæ™¯å¹¶é‡‡ç”¨å¯¹åº”ç­–ç•¥ï¼š

### åœºæ™¯ 1ï¸âƒ£ï¼šé£Ÿç‰©åˆ†æ / èƒ½ä¸èƒ½åƒ
**è§¦å‘è¯**ï¼šå…·ä½“é£Ÿç‰©åç§° + "èƒ½åƒå—/å¯ä»¥åƒå—/é€‚åˆå—"
**å·¥ä½œæµ**ï¼š
1. è¯†åˆ«é£Ÿç‰© â†’ æŸ¥å››æ°”äº”å‘³ã€è¥å…»æˆåˆ†ã€å˜Œå‘¤/é’ /GI æ•°å€¼
2. **å†²çªæ£€æµ‹**ï¼šäº¤å‰æ¯”å¯¹ç”¨æˆ·æ‰€æœ‰å¥åº·æ¡£æ¡ˆæ¡ç›®
3. ç»™å‡º âœ… å¯ä»¥ / âš ï¸ å°‘é‡ï¼ˆé™„é™é‡æ ‡å‡†ï¼‰/ ğŸš« ç¦æ­¢ çš„æ˜ç¡®ç»“è®º
4. å¦‚æœç¦æ­¢ï¼Œæ¨è 2-3 ä¸ªåŠŸèƒ½ç­‰ä»·çš„æ›¿ä»£é£Ÿç‰©
5. è§£é‡Šç”Ÿç‰©å­¦/ä¸­åŒ»æœºåˆ¶ï¼ˆä¸ºä»€ä¹ˆï¼‰

### åœºæ™¯ 2ï¸âƒ£ï¼šé¥®é£Ÿè®¡åˆ’ / ä¸€æ—¥ä¸‰é¤
**è§¦å‘è¯**ï¼š"åƒä»€ä¹ˆ/é£Ÿè°±/ä¸‰é¤/ä¸€å‘¨é£Ÿè°±/ä»Šå¤©åƒä»€ä¹ˆ"
**å·¥ä½œæµ**ï¼š
1. åˆ†æç”¨æˆ·ä»£è°¢ç›®æ ‡ï¼ˆæ§ç³–/æ§å°¿é…¸/å‡è„‚ç­‰ï¼‰ï¼Œæ‰§è¡Œ**äº¤é›†è¿ç®—**ï¼šå¤šä¸ªçº¦æŸæ¡ä»¶å–äº¤é›†
2. è®¡ç®—æ¯æ—¥çƒ­é‡ä¸å®é‡ç´ ç›®æ ‡ï¼ˆåŸºäº BMR + æ´»åŠ¨ç³»æ•°ï¼‰
3. åˆ¶å®šå…·ä½“èœå•ï¼ˆç²¾ç¡®åˆ°é£Ÿæå’Œå…‹æ•°ã€çƒ¹é¥ªæ–¹å¼ï¼‰
4. æ ‡æ³¨ä¸­åŒ»é£Ÿç–—è¦ç‚¹ï¼ˆå¦‚"æ™¨èµ·å®œæ¸©ç²¥å…»èƒƒ"ï¼‰
5. é™„æ³¨æ¯é¤é¢„ä¼°çƒ­é‡å’Œå…³é”®æŒ‡æ ‡

### åœºæ™¯ 3ï¸âƒ£ï¼šç—‡çŠ¶/ç–¾ç—…ç›¸å…³é¥®é£Ÿå’¨è¯¢
**è§¦å‘è¯**ï¼šç—…å/ç—‡çŠ¶ + "é¥®é£Ÿ/åƒä»€ä¹ˆå¥½/å¿Œå£"
**å·¥ä½œæµ**ï¼š
1. ç¡®è®¤ç–¾ç—…/ç—‡çŠ¶çš„é¥®é£Ÿç›¸å…³æ€§
2. ä»**è¥¿åŒ»å¾ªè¯æŒ‡å—**æå–é¥®é£Ÿå»ºè®®ï¼ˆå¼•ç”¨æŒ‡å—åç§°ï¼‰
3. ä»**ä¸­åŒ»è§’åº¦**è¡¥å……é£Ÿç–—è¾¨è¯ï¼ˆå¦‚è„¾è™šæ¹¿ç›› â†’ å¥è„¾ç¥›æ¹¿æ–¹ï¼‰
4. ç»™å‡º"å®œåƒ"å’Œ"å¿Œåƒ"æ¸…å•ï¼ˆé™„å…·ä½“æ•°å€¼é™åˆ¶ï¼‰
5. âš ï¸ å£°æ˜ï¼šä¸¥é‡æƒ…å†µè¯·å°±åŒ»ï¼Œæœ¬å»ºè®®ä»…ä¾›å‚è€ƒ

### åœºæ™¯ 4ï¸âƒ£ï¼šè¿åŠ¨ä¸è¥å…»
**è§¦å‘è¯**ï¼š"å¥èº«/é”»ç‚¼/è¿åŠ¨/å¢è‚Œ/å‡è„‚/è·‘æ­¥/æ¸¸æ³³"
**å·¥ä½œæµ**ï¼š
1. ç¡®è®¤è¿åŠ¨ç±»å‹å’Œå¼ºåº¦
2. è®¡ç®—è¿åŠ¨å‰åè¥å…»éœ€æ±‚ï¼ˆç¢³æ°´çª—å£ã€è›‹ç™½è´¨æ—¶æœºã€ç”µè§£è´¨è¡¥å……ï¼‰
3. ç»™å‡ºè®­ç»ƒæ—¥/ä¼‘æ¯æ—¥çš„å·®å¼‚åŒ–é¥®é£Ÿæ–¹æ¡ˆ
4. ä¸­åŒ»è§†è§’è¡¥å……ï¼ˆå¦‚è¿åŠ¨åå¤§æ±—åº”é¿å…å¯’å‡‰ï¼Œå®œæ¸©è¡¥æ°”è¡€ï¼‰
5. æ¯é¤ç²¾ç¡®åˆ°å®é‡ç´ åˆ†é…æ¯”ä¾‹

### åœºæ™¯ 5ï¸âƒ£ï¼šé£Ÿç‰©å¯¹æ¯” / æ•°æ®æŸ¥è¯¢
**è§¦å‘è¯**ï¼š"XXå’ŒYYå“ªä¸ªå¥½/æ¯”è¾ƒ/çƒ­é‡å¤šå°‘/è¥å…»æˆåˆ†"
**å·¥ä½œæµ**ï¼š
1. åˆ—å‡ºå¯¹æ¯”ç»´åº¦ï¼ˆçƒ­é‡ã€GIã€å˜Œå‘¤ã€é’ ã€å…³é”®å¾®é‡ç´ ï¼‰
2. ç”¨è¡¨æ ¼å½¢å¼æ¸…æ™°å¯¹æ¯”
3. ç»“åˆç”¨æˆ·å¥åº·çŠ¶å†µç»™å‡ºä¸ªæ€§åŒ–æ¨è
4. é™„æ³¨ä¸­è¥¿åŒ»è§‚ç‚¹å·®å¼‚ï¼ˆå¦‚æœ‰ï¼‰

### åœºæ™¯ 6ï¸âƒ£ï¼šé£Ÿç‰©æ‹ç…§è¯†åˆ«ï¼ˆå›¾ç‰‡åˆ†æï¼‰
**è§¦å‘è¯**ï¼šç”¨æˆ·ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡
**å·¥ä½œæµ**ï¼š
1. **è¯†åˆ«**ï¼šæ£€å‡ºæ‰€æœ‰é£Ÿæã€çƒ¹é¥ªæ–¹å¼ï¼ˆæ²¹ç‚¸/æ¸…è’¸/çº¢çƒ§ï¼‰ã€ä¼°ç®—åˆ†é‡
2. **é‡åŒ–**ï¼šé¢„ä¼°æ•´é¤çš„çƒ­é‡ã€é’ ã€å˜Œå‘¤ã€ä¸‰å¤§å®é‡ç´ 
3. **å†²çªæ£€æµ‹**ï¼šæ¯”å¯¹ç”¨æˆ·æ¡£æ¡ˆï¼Œæ ‡è®°é«˜é£é™©é£Ÿæ
4. **è¾“å‡º**ï¼šé£é™©ç­‰çº§ + å½’å›  + æ”¹è‰¯å»ºè®®ï¼ˆå¦‚"å»ºè®®ä»…é£Ÿç”¨å…¶ä¸­çš„è”¬èœï¼Œæ¸…æ°´æ¶®æ´—åé£Ÿç”¨"ï¼‰

### åœºæ™¯ 7ï¸âƒ£ï¼šæ—¥å¸¸é—²èŠ / é€šç”¨é—®é¢˜
**è§¦å‘è¯**ï¼šä¸å±äºä»¥ä¸Šåœºæ™¯
**å·¥ä½œæµ**ï¼š
1. å‹å¥½å›åº”ï¼Œä¿æŒé£Ÿé‰´AIçš„ä¸“ä¸šäººè®¾
2. åç¦»å¥åº·é¢†åŸŸæ—¶ï¼Œæ¸©å’Œå¼•å¯¼å›é¥®é£Ÿå¥åº·è¯é¢˜
3. é€‚å½“åˆ†äº«æœ‰è¶£çš„å…»ç”Ÿå†·çŸ¥è¯†æˆ–é£Ÿç–—å…¸æ•…

---

## å››ã€å®‰å…¨çº¢çº¿ï¼ˆç»ä¸å¯è¿åï¼‰

### åŸºç¡€å®‰å…¨
1. âŒ **ä¸åšåŒ»ç–—è¯Šæ–­**ï¼šä¸è¯´"ä½ å¾—äº†XXç—…"ï¼Œåªè¯´"æ ¹æ®æ‚¨æè¿°çš„ç—‡çŠ¶ï¼Œå»ºè®®å°±åŒ»æ’æŸ¥"
2. âŒ **ä¸ç»™æç«¯å»ºè®®**ï¼šå¦‚æä½çƒ­é‡é¥®é£Ÿï¼ˆ<800kcal/å¤©ï¼‰ã€é•¿æœŸæ–­é£Ÿç­‰
3. âŒ **ä¸å¿½è§†è¿‡æ•æº**ï¼šç”¨æˆ·æ¡£æ¡ˆä¸­çš„è¿‡æ•é£Ÿç‰©ï¼Œæ— è®ºåœºæ™¯éƒ½å¿…é¡»åŠ  ğŸš« è­¦å‘Š
4. âœ… **é‡ä¸ç¡®å®šæ—¶å¦æ‰¿**ï¼š"è¿™ä¸ªé—®é¢˜è¶…å‡ºæˆ‘çš„ä¸“ä¸šèŒƒå›´ï¼Œå»ºè®®å’¨è¯¢åŒ»ç”Ÿ/è¥å…»å¸ˆ"

### ğŸš¨ æ€¥ç—‡ç†”æ–­æœºåˆ¶
è‹¥ç”¨æˆ·æè¿°å‡ºç°ä»¥ä¸‹å…³é”®è¯ï¼Œ**ç«‹å³åœæ­¢åˆ†æ**ï¼Œç›´æ¥è¾“å‡ºæ€¥æ•‘æç¤ºï¼š
- è§¦å‘è¯ï¼šèƒ¸ç—›ã€æ”¾å°„æ€§èƒŒç—›ã€å…³èŠ‚å‰§çƒˆçº¢è‚¿çƒ­ç—›ã€æ„è¯†æ¨¡ç³Šã€å‘¼å¸å›°éš¾ã€æŒç»­é«˜çƒ§
- è¾“å‡ºæ¨¡æ¿ï¼š"âš ï¸ æ£€æµ‹åˆ°ç–‘ä¼¼æ€¥æ€§ç—‡çŠ¶é£é™©ã€‚è¯·ç«‹å³åœæ­¢ä½¿ç”¨ APPï¼Œæ‹¨æ‰“æ€¥æ•‘ç”µè¯æˆ–å‰å¾€æœ€è¿‘çš„åŒ»é™¢æ€¥è¯Šã€‚æ‚¨çš„å¥åº·å®‰å…¨æ˜¯ç¬¬ä¸€ä½çš„ã€‚"

### ğŸ’Š è¯ç‰©å®‰å…¨è¾¹ç•Œ
- âœ… **å¯ä»¥åš**ï¼šè¯†åˆ«è¯ç›’å›¾ç‰‡ï¼Œæç¤º"è¯¥è¯ç‰©ä¸é…’ç²¾/æŸšå­æ±å­˜åœ¨äº¤äº’é£é™©"
- âœ… **å¯ä»¥åš**ï¼šå»ºè®®"è¯·å’¨è¯¢ä¸»æ²»åŒ»ç”Ÿè°ƒæ•´ç”¨è¯æ–¹æ¡ˆ"
- âŒ **ä¸¥ç¦**ï¼šæ¨èå…·ä½“å¤„æ–¹è¯åç§°æˆ–å‰‚é‡ï¼ˆå¦‚"ä½ è¯¥åƒä¸¤ç‰‡éå¸ƒå¸ä»–" â†’ ç»ä¸å¯ä»¥ï¼‰
- âŒ **ä¸¥ç¦**ï¼šæ›¿ç”¨æˆ·åˆ¤æ–­æ˜¯å¦åº”è¯¥åœè¯/æ¢è¯

---

## äº”ã€ç”¨æˆ·å¥åº·æ¡£æ¡ˆ

{user_context}
"""


class DoubaoAIService:
    """è±†åŒ… AI æœåŠ¡"""
    
    def __init__(self):
        self.client = None
        self._initialized = False
        self._lock = asyncio.Lock()
    
    async def _ensure_initialized(self):
        """ç¡®ä¿ SDK å·²åˆå§‹åŒ–"""
        if self._initialized:
            return
        
        async with self._lock:
            if self._initialized:
                return
            
            if not settings.ark_api_key:
                raise RuntimeError("è±†åŒ… API å¯†é’¥æœªé…ç½®ï¼Œè¯·è®¾ç½® ARK_API_KEY ç¯å¢ƒå˜é‡")
            
            try:
                from volcenginesdkarkruntime import Ark
                
                self.client = Ark(api_key=settings.ark_api_key)
                self._initialized = True
            except ImportError:
                raise RuntimeError("è¯·å®‰è£… volcengine-python-sdk[ark]")
    
    def _build_user_context(
        self,
        user: User,
        conditions: List[HealthCondition]
    ) -> str:
        """æ„å»ºç”¨æˆ·å¥åº·ä¸Šä¸‹æ–‡ï¼ˆä¾› AI å‚è€ƒï¼‰"""
        context_parts = []
        
        # åŸºæœ¬ä¿¡æ¯ + BMR è®¡ç®—
        if user.gender and user.age and user.height and user.weight:
            gender_str = "ç”·" if user.gender.value == "MALE" else "å¥³"
            bmi = round(user.weight / (user.height / 100) ** 2, 1)
            
            # Mifflin-St Jeor å…¬å¼è®¡ç®— BMR
            if user.gender.value == "MALE":
                bmr = round(10 * user.weight + 6.25 * user.height - 5 * user.age + 5)
            else:
                bmr = round(10 * user.weight + 6.25 * user.height - 5 * user.age - 161)
            
            tdee = round(bmr * 1.4)  # è½»åº¦æ´»åŠ¨ç³»æ•°
            
            context_parts.append(
                f"- åŸºæœ¬ä¿¡æ¯ï¼š{gender_str}ï¼Œ{user.age}å²ï¼Œèº«é«˜{user.height}cmï¼Œä½“é‡{user.weight}kg"
            )
            context_parts.append(f"- BMIï¼š{bmi}ï¼ˆ{'åç˜¦' if bmi < 18.5 else 'æ­£å¸¸' if bmi < 24 else 'åèƒ–' if bmi < 28 else 'è‚¥èƒ–'}ï¼‰")
            context_parts.append(f"- å‚è€ƒåŸºç¡€ä»£è°¢ï¼š{bmr}kcal/å¤©ï¼Œé¢„ä¼°æ€»æ¶ˆè€—ï¼š{tdee}kcal/å¤©")
        
        # æ…¢æ€§ç—…ï¼ˆå«çŠ¶æ€å’Œå…·ä½“æŒ‡æ ‡ï¼‰
        chronic_conditions = [c for c in conditions if c.condition_type.value == "CHRONIC"]
        if chronic_conditions:
            context_parts.append("- æ…¢æ€§ç—…å²ï¼š")
            for c in chronic_conditions:
                status_str = {"ACTIVE": "æ´»è·ƒæœŸ", "MONITORING": "ç›‘æµ‹ä¸­", "STABLE": "ç¨³å®šæœŸ"}.get(c.status.value if c.status else "", "æœªçŸ¥")
                detail = f"  Â· {c.title}ï¼ˆ{status_str}ï¼‰"
                if c.value and c.unit:
                    detail += f" â€” æœ€è¿‘å€¼ï¼š{c.value}{c.unit}"
                context_parts.append(detail)
        
        # è¿‡æ•æºï¼ˆé«˜ä¼˜å…ˆçº§è­¦å‘Šï¼‰
        allergies = [c for c in conditions if c.condition_type.value == "ALLERGY"]
        if allergies:
            allergy_str = "ã€".join([f"**{c.title}**" for c in allergies])
            context_parts.append(f"- ğŸš« è¿‡æ•æºï¼ˆç»å¯¹ç¦æ­¢ï¼‰ï¼š{allergy_str}")
        
        if not context_parts:
            return "ç”¨æˆ·å°šæœªå®Œå–„å¥åº·æ¡£æ¡ˆï¼Œè¯·åœ¨ç»™å‡ºå»ºè®®æ—¶æé†’ç”¨æˆ·å®Œå–„ä¸ªäººå¥åº·ä¿¡æ¯ã€‚"
        
        return "\n".join(context_parts)
    
    async def chat(
        self,
        messages: List[Dict[str, str]],
        user: User,
        conditions: List[HealthCondition],
        stream: bool = False
    ) -> Union[AsyncGenerator[str, None], str]:
        """
        ä¸è±†åŒ…å¯¹è¯
        
        Args:
            messages: å¯¹è¯å†å²
            user: å½“å‰ç”¨æˆ·
            conditions: ç”¨æˆ·å¥åº·çŠ¶å†µ
            stream: æ˜¯å¦æµå¼è¿”å›
        
        Returns:
            AI å›å¤å†…å®¹
        """
        await self._ensure_initialized()
        
        user_context = self._build_user_context(user, conditions)
        system_message = {
            "role": "system",
            "content": SYSTEM_PROMPT.format(user_context=user_context)
        }
        
        full_messages = [system_message] + messages
        
        if stream:
            return self._stream_chat(full_messages)
        else:
            return await self._sync_chat(full_messages)
    
    async def _sync_chat(self, messages: List[Dict[str, str]]) -> str:
        """åŒæ­¥å¯¹è¯"""
        try:
            response = self.client.chat.completions.create(
                model=settings.doubao_endpoint_id,
                messages=messages,
                temperature=0.7,
                max_tokens=2000
            )
            return response.choices[0].message.content
        except Exception as e:
            return f"æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼š{str(e)}"
    
    async def _stream_chat(
        self,
        messages: List[Dict[str, str]]
    ) -> AsyncGenerator[str, None]:
        """æµå¼å¯¹è¯"""
        try:
            stream = self.client.chat.completions.create(
                model=settings.doubao_endpoint_id,
                messages=messages,
                temperature=0.7,
                max_tokens=2000,
                stream=True
            )
            
            for chunk in stream:
                if chunk.choices and chunk.choices[0].delta.content:
                    yield chunk.choices[0].delta.content
        except Exception as e:
            yield f"æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼š{str(e)}"
    
    async def recognize_food(
        self,
        image_base64: str,
        user: User,
        conditions: List[HealthCondition]
    ) -> tuple[List[FoodRecognitionResult], str]:
        """
        è¯†åˆ«é£Ÿç‰©å›¾ç‰‡
        
        Args:
            image_base64: Base64 ç¼–ç çš„å›¾ç‰‡
            user: å½“å‰ç”¨æˆ·
            conditions: ç”¨æˆ·å¥åº·çŠ¶å†µ
        
        Returns:
            (è¯†åˆ«ç»“æœåˆ—è¡¨, AI å¯¹è¯å¼å›å¤)
        """
        await self._ensure_initialized()
        
        user_context = self._build_user_context(user, conditions)
        
        # è·å–è¿‡æ•æºåˆ—è¡¨ç”¨äºè­¦å‘Š
        allergies = [c.title for c in conditions if c.condition_type.value == "ALLERGY"]
        allergy_warning = f"ç”¨æˆ·å¯¹ä»¥ä¸‹é£Ÿç‰©è¿‡æ•ï¼š{', '.join(allergies)}" if allergies else ""
        
        recognition_prompt = f"""è¯·ä»”ç»†åˆ†æè¿™å¼ é£Ÿç‰©å›¾ç‰‡ï¼Œè¯†åˆ«å…¶ä¸­çš„æ‰€æœ‰é£Ÿç‰©ï¼Œå¹¶æä¾›è¯¦ç»†çš„è¥å…»åˆ†æã€‚

{allergy_warning}

è¯·ä»¥ JSON æ ¼å¼è¿”å›åˆ†æç»“æœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{{
    "foods": [
        {{
            "food_name": "é£Ÿç‰©åç§°",
            "confidence": 0.95,
            "estimated_portion": "ä¼°ç®—ä»½é‡ï¼ˆå¦‚ï¼šçº¦150gï¼‰",
            "nutrition": {{
                "calories": çƒ­é‡(kcal),
                "sodium": é’ å«é‡(mg),
                "purine": å˜Œå‘¤å«é‡(mg),
                "protein": è›‹ç™½è´¨(g),
                "carbs": ç¢³æ°´åŒ–åˆç‰©(g),
                "fat": è„‚è‚ª(g),
                "fiber": è†³é£Ÿçº¤ç»´(g)
            }},
            "category": "STAPLE/MEAT/VEG/DRINK/SNACK",
            "health_tips": "é’ˆå¯¹ç”¨æˆ·å¥åº·çŠ¶å†µçš„å»ºè®®",
            "warnings": ["è­¦å‘Šä¿¡æ¯åˆ—è¡¨ï¼Œå¦‚è¿‡æ•è­¦å‘Š"]
        }}
    ],
    "ai_response": "ä»¥é£Ÿé‰´AIèº«ä»½ç»™å‡ºçš„å¯¹è¯å¼å›å¤ï¼ŒåŒ…å«å¯¹è¿™é¡¿é¥­çš„æ•´ä½“è¯„ä»·å’Œå»ºè®®"
}}

ç”¨æˆ·å¥åº·æ¡£æ¡ˆï¼š
{user_context}
"""
        
        try:
            response = self.client.chat.completions.create(
                model=settings.doubao_vision_endpoint_id,
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{image_base64}"
                                }
                            },
                            {
                                "type": "text",
                                "text": recognition_prompt
                            }
                        ]
                    }
                ],
                temperature=0.3,
                max_tokens=2000
            )
            
            content = response.choices[0].message.content
            
            # å°è¯•è§£æ JSON
            try:
                # ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
                if "```json" in content:
                    content = content.split("```json")[1].split("```")[0]
                elif "```" in content:
                    content = content.split("```")[1].split("```")[0]
                
                result = json.loads(content.strip())
                
                foods = [
                    FoodRecognitionResult(
                        food_name=f["food_name"],
                        confidence=f.get("confidence", 0.8),
                        estimated_portion=f["estimated_portion"],
                        nutrition=NutritionInfo(**f["nutrition"]),
                        category=f["category"],
                        health_tips=f.get("health_tips"),
                        warnings=f.get("warnings", [])
                    )
                    for f in result.get("foods", [])
                ]
                
                ai_response = result.get("ai_response", "è¯†åˆ«å®Œæˆï¼Œè¯·æŸ¥çœ‹è¥å…»åˆ†æã€‚")
                
                return foods, ai_response
                
            except json.JSONDecodeError:
                # JSON è§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
                return [], content
                
        except Exception as e:
            return [], f"é£Ÿç‰©è¯†åˆ«å¤±è´¥ï¼š{str(e)}"


# å•ä¾‹å®ä¾‹
doubao_service = DoubaoAIService()
